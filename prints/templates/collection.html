{% extends "base.html" %}{% load static %}
{% block title %}przeglądaj - starodruki{% endblock %}


{% block content %}
<div class="margin-t-small"></div>
<div class="row">
    <div class="col-md-3 col-sm-4 col-lg-2">
        <form id="filter-form" class="filter-form">
            <h5 class="brown-text t-title">Filtrowanie</h5>

            {{ filter.form.as_p }}

            <!--<button type="submit">Filtruj</button>-->
        </form>
    </div>
    <div class="col-md-9 col-sm-8 col-lg-10">
        <div class="row mix-container"></div>
        <div class="row text-center">
            <div class="pages" role="group">
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block extra_script %}
<script src="{% static "/js/mixitup.min.js" %}"></script>

<script>

var current_page = 1;
var current_job = 0;
var num_pages = 1;

var mixer = mixitup('.mix-container', {
    controls: {
        toggleDefault: 'none'
    },
    data: {
        uidKey: 'id'
    },
    render: {
        target: render
    },
    selectors: {
        target: '[data-ref="mix"]'
    }
});

function update_pages() {
    text = '';
    k = current_page - 2;
    if (k<1) {k=1;};
    if (current_page > 1) {
        text = '<button onclick="javascript:previous_page()" class="btn brown-btn page-arrow"><<</button>';
    }

    for (;k <= current_page+2 && k <= num_pages; k++){
        if (k == current_page){
            text = text + '<button class="btn brown-btn page-number active">' + k + '</button>';
        }
        else {
            text = text + '<button onclick="javascript:page('+k+')" class="btn brown-btn page-number">' + k + '</button>';
        }
    }

    if (num_pages > current_page) {
        text = text + '<button onclick="javascript:next_page()" class="btn brown-btn page-arrow">>></button>';
    }
    $('.pages').html(text);
}

function try_set(data) {
    if (data.job != current_job) return;
    if (mixer.isMixing()){
        setTimeout(function (){try_set(data)}, 200);
        return;
    }
    if (data.job == current_job){
        num_pages = data.num_pages;
        mixer.dataset(data.data);
        update_pages();
    }
}

function get_prints() {
    current_job = (current_job + 1) % 65535;
    $.get('/api/v1/prints/' + current_page.toString() + '/?' + $('#filter-form').serialize() + '&job=' + current_job.toString(), function(data) {
        try_set($.parseJSON(data));
    });
}

function render(print) {
    return `
<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3 col-xl-3" data-ref="mix", >
    <div class="content-box">
        <img src="{% static "" %}${print.title_page}" alt="Strona tytułowa" class="margin-b-20 img-fluid fixed-img">
        <h4 class="margin-b-0 brown-text" title="${print.title}">${print.title}</h4>
        <p class="margin-b-0 print-info" title="${print.author_khw}">${print.author_khw}</p>
        <p class="margin-b-20 print-info" title="${print.publication_date}"><i>(${print.publication_date})</i></p>
        <a href="/prints/single/${print.id}" class="brown-btn text-uppercase">Zobacz</a>
        <hr>
    </div>
</div>
`;};

$("#filter-form input").bind('input', function() {
    current_page = 1;
    get_prints();
});

$(document).ready(get_prints);

function page(page){
    if (page > 0 && page <= num_pages){
        current_page = page;
        update_pages();
        get_prints();
    }
}

function next_page(){
    page(current_page+1);
};

function previous_page(){
    page(current_page-1);
};



</script>

{% endblock %}